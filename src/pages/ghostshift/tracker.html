<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GhostShift Tracker | TRS Alliance</title>
    <style>
        /* TRS Vibe: Black + muted neon, typewriter glitch */
        body { 
            margin: 0; padding: 0; font-family: 'Courier New', monospace; 
            background: #000; color: #00ffff; /* cyan neon */
            overflow-x: hidden;
        }
        .glitch { 
            position: relative; 
            animation: glitch 1s infinite; 
        }
        @keyframes glitch {
            0%, 100% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
        }
        .container { max-width: 400px; margin: 0 auto; padding: 20px; }
        input, select, textarea { 
            width: 100%; padding: 10px; margin: 5px 0; 
            background: #111; border: 1px solid #00ffff; color: #00ffff; 
            font-family: inherit; box-sizing: border-box;
        }
        button { 
            width: 100%; padding: 15px; margin: 10px 0; 
            background: #00ffff; color: #000; border: none; 
            font-weight: bold; cursor: pointer; font-size: 16px;
        }
        button:hover { background: #00cccc; }
        .hidden { display: none; }
        .receipt { text-align: center; padding: 20px; }
        #quote { min-height: 60px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.js"></script> <!-- Client-side hashing -->
</head>
<body>
    <div class="container">
        <h1 class="glitch">WHAT CHANGED?</h1>
        <p>Anonymous. Secure. Yours.</p>
        
        <form id="trackerForm">
            <label>I was...</label>
            <select id="role" required>
                <option value="">Select</option>
                <option value="full-time">Full-time employee</option>
                <option value="contractor">Contractor / agency</option>
                <option value="gig">Gig platform worker</option>
                <option value="vendor">Vendor / subcontractor</option>
                <option value="other">Other</option>
            </select>

            <label>At (optional - hashed for privacy)</label>
            <input type="text" id="company" placeholder="Company name">

            <label>City / Region</label>
            <input type="text" id="location" placeholder="e.g., San Francisco" required>

            <label>When did the shift hit?</label>
            <select id="when" required>
                <option value="">Select</option>
                <option value="last-week">Last week</option>
                <option value="last-month">Last month</option>
                <option value="last-3-months">Last 3 months</option>
                <option value="other">Other</option>
            </select>

            <label>How it went down (multi-select)</label>
            <div id="displacement">
                <label><input type="checkbox" value="laid-off"> Laid off / fired</label><br>
                <label><input type="checkbox" value="role-elim"> “Role eliminated”</label><br>
                <label><input type="checkbox" value="contract-end"> Contract not renewed</label><br>
                <label><input type="checkbox" value="hours-cut"> Hours cut / forced part-time</label><br>
                <label><input type="checkbox" value="managed-out"> Quietly managed out</label><br>
                <label><input type="checkbox" value="ai-replace"> Replaced by AI / automation</label><br>
                <label><input type="checkbox" value="other"> Other</label>
            </div>

            <label>Where I landed (or trying to)</label>
            <select id="landed" required>
                <option value="">Select</option>
                <option value="new-ft">New full-time job</option>
                <option value="freelance">Freelance / gig hustle</option>
                <option value="own-thing">Started my own thing</option>
                <option value="side-jobs">Multiple side jobs</option>
                <option value="out">Out of workforce (health/family/etc)</option>
                <option value="looking">Still looking</option>
            </select>

            <label>One line for the record (optional)</label>
            <textarea id="quote" placeholder="e.g., I trained the model that replaced me."></textarea>

            <button type="submit">SUBMIT TRUTH</button>
        </form>

        <div id="receipt" class="hidden receipt">
            <h2>TRUTH RECEIVED.</h2>
            <p>Your shift is now part of the map.</p>
            <p><strong>ID: <span id="idCode"></span></strong></p>
            <p>You own this data. Always.</p>
            <button onclick="location.reload()">Track Another</button>
            <button onclick="shareQR()">Share GhostShift</button>
        </div>
    </div>

    <script>
        // Offline-first: Use localStorage fallback, sync to Supabase on connect
        const SUPABASE_URL = 'https://your-project.supabase.co'; // Replace with real
        const SUPABASE_KEY = 'your-anon-key'; // Anon key only
        let supabase;

        // Init Supabase (or fallback to local)
        async function initSupabase() {
            if (typeof supabase === 'undefined') {
                const { createClient } = await import('https://esm.sh/@supabase/supabase-js@2');
                supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
            }
            return supabase;
        }

        // Generate unique ID: timestamp + device hash
        function generateID() {
            const timestamp = Date.now();
            const deviceHash = CryptoJS.MD5(navigator.userAgent + screen.width + screen.height).toString();
            return `GS-${timestamp}-${deviceHash.substring(0,4).toUpperCase()}`;
        }

        // Hash sensitive fields client-side
        function hashField(field) {
            if (!field) return null;
            return CryptoJS.SHA256(field).toString();
        }

        // Form submit handler
        document.getElementById('trackerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = {
                id: generateID(),
                role: document.getElementById('role').value,
                company: hashField(document.getElementById('company').value),
                location: document.getElementById('location').value,
                when: document.getElementById('when').value,
                displacement: Array.from(document.querySelectorAll('#displacement input:checked')).map(cb => cb.value),
                landed: document.getElementById('landed').value,
                quote: document.getElementById('quote').value || null,
                timestamp: new Date().toISOString(),
                verified: 0 // Starts at 0, community votes up
            };

            // Try Supabase insert, fallback to localStorage
            try {
                await initSupabase();
                const { data, error } = await supabase.from('ghostshifts').insert([formData]);
                if (error) throw error;
                console.log('Submitted:', data);
            } catch (err) {
                // Offline: Store locally for later sync
                const offline = JSON.parse(localStorage.getItem('ghostshift_offline') || '[]');
                offline.push(formData);
                localStorage.setItem('ghostshift_offline', JSON.stringify(offline));
                // Auto-sync on next load if online
                window.addEventListener('online', syncOffline);
            }

            // Show receipt
            document.getElementById('idCode').textContent = formData.id;
            document.getElementById('trackerForm').classList.add('hidden');
            document.getElementById('receipt').classList.remove('hidden');
        });

        // Sync offline data
        async function syncOffline() {
            const offline = JSON.parse(localStorage.getItem('ghostshift_offline') || '[]');
            if (offline.length === 0) return;
            try {
                await initSupabase();
                const { error } = await supabase.from('ghostshifts').insert(offline);
                if (!error) localStorage.removeItem('ghostshift_offline');
            } catch (err) { console.log('Sync failed:', err); }
        }

        // Share QR (placeholder - integrate QR code gen lib if needed)
        function shareQR() {
            if (navigator.share) {
                navigator.share({ title: 'GhostShift Tracker', url: window.location.href });
            } else {
                prompt('Copy this link to share:', window.location.href);
            }
        }

        // Auto-sync on load
        if (navigator.onLine) syncOffline();
    </script>
</body>
</html>
